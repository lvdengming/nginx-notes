# 设置方式：
# 1、在 /etc/nginx/sites-available/default 添加以下内容
# 2、在 /etc/nginx/sites-available 目录下新建一个文件，例如 api-gateway
# 创建软连接到 /etc/nginx/sites-enabled 目录下
# sudo ln -s /etc/nginx/sites-available/api-gateway /etc/nginx/sites-enabled/

# 定义负载均衡上游服务器组
upstream backend_nodes {
  # 默认轮询策略
  server 8.141.84.169:3000;    # aliyun
  server 49.232.221.153:3000;  # tencent

  # 提升性能
  keepalive 32;
}

server {
  listen 80;
  server_name 8.141.84.169;

  # 开启 gzip 压缩，提升前端性能
  gzip on;
  gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

  # 前端静态文件路径
  # 占位

  # 反向代理（负载均衡）
  location /api/ {
    # 将请求转发到上游服务器组
    proxy_pass http://backend_nodes;

    # 传递必要的头部信息
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # 超时设置
    proxy_connect_timeout 5s;
    proxy_send_timeout 10s;
    proxy_read_timeout 10s;

    # 禁用缓存
    proxy_buffering off;
  }

  # 可选：健康检查接口直接访问后端（不经过负载均衡）
  # location /health {
  #   proxy_pass http://backend_nodes/health;
  # }

  # 日志配置
  access_log /var/log/nginx/access.log;
  error_log /var/log/nginx/error.log;
}
